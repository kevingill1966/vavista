This code is lifted directly from FMQL (caregraf.org). It is put
here to make it easier for me to reuse.
